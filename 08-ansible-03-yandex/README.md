# Домашнее задание к занятию 3 «Использование Ansible»

## Подготовка к выполнению

1. Подготовьте в Yandex Cloud три хоста: для `clickhouse`, для `vector` и для `lighthouse`.
2. Репозиторий LightHouse находится [по ссылке](https://github.com/VKCOM/lighthouse).

## Основная часть

1. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает LightHouse.
2. При создании tasks рекомендую использовать модули: `get_url`, `template`, `yum`, `apt`.
3. Tasks должны: скачать статику LightHouse, установить Nginx или любой другой веб-сервер, настроить его конфиг 
для открытия LightHouse, запустить веб-сервер.
4. Подготовьте свой inventory-файл `prod.yml`.
5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.
6. Попробуйте запустить playbook на этом окружении с флагом `--check`.
7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.
8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.
9. Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги. [Инстуркция](https://github.com/EVolgina/ansible03/blob/main/08-ansible-03-yandex/instruction)
10. Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-03-yandex` на фиксирующий коммит, в ответ предоставьте ссылку на него.
```
ansible-playbook -i inventory/prod.yml site.yml
PLAY [Install Clickhouse] **********************************************************************************************
TASK [Gathering Facts] *************************************************************************************************
ok: [84.201.128.52]
TASK [Get clickhouse distrib] ******************************************************************************************
ok: [84.201.128.52] => (item=clickhouse-client)
ok: [84.201.128.52] => (item=clickhouse-server)
ok: [84.201.128.52] => (item=clickhouse-common-static)
TASK [Install clickhouse packages] *************************************************************************************
ok: [84.201.128.52]
TASK [Flush handlers] **************************************************************************************************
TASK [Create database] *************************************************************************************************
ok: [84.201.128.52]
PLAY [Install Vector] **************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************
ok: [158.160.101.156]
TASK [Get Vector distrib] **********************************************************************************************
ok: [158.160.101.156]
TASK [Install Vector] **************************************************************************************************
ok: [158.160.101.156]

PLAY [lighthouse] ******************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************
ok: [158.160.118.75]

TASK [Ensure Ansible uses Python 3] ************************************************************************************
ok: [158.160.118.75]

PLAY [Install nginx] ***************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************
ok: [158.160.118.75]

TASK [Install nginx] ***************************************************************************************************
ok: [158.160.118.75]
PLAY [Install lighthouse] **********************************************************************************************
TASK [Gathering Facts] *************************************************************************************************
ok: [158.160.118.75]
TASK [Install unzip] ***************************************************************************************************
ok: [158.160.118.75]
TASK [Get lighthouse distrib] ******************************************************************************************
changed: [158.160.118.75]
TASK [Unarchive lighthouse distrib into nginx] *************************************************************************
ok: [158.160.118.75]
TASK [Make nginx config] ***********************************************************************************************
changed: [158.160.118.75]
TASK [Remove lighthouse distrib] ***************************************************************************************
changed: [158.160.118.75]
PLAY RECAP *************************************************************************************************************
158.160.101.156            : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
158.160.118.75             : ok=10   changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
84.201.128.52              : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible-playbook -i inventory/prod.yml site.yml --check

PLAY [Install Clickhouse] **********************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [84.201.128.52]
TASK [Get clickhouse distrib] ******************************************************************************************************************************************
ok: [84.201.128.52] => (item=clickhouse-client)
ok: [84.201.128.52] => (item=clickhouse-server)
ok: [84.201.128.52] => (item=clickhouse-common-static)
TASK [Install clickhouse packages] *************************************************************************************************************************************
ok: [84.201.128.52]
TASK [Flush handlers] **************************************************************************************************************************************************
TASK [Create database] *************************************************************************************************************************************************
skipping: [84.201.128.52]
PLAY [Install Vector] **************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.101.156]
TASK [Get Vector distrib] **********************************************************************************************************************************************
ok: [158.160.101.156]
TASK [Install Vector] **************************************************************************************************************************************************
ok: [158.160.101.156]
PLAY [lighthouse] ******************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]
TASK [Ensure Ansible uses Python 3] ************************************************************************************************************************************
ok: [158.160.118.75]
PLAY [Install nginx] ***************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]
TASK [Install nginx] ***************************************************************************************************************************************************
ok: [158.160.118.75]
PLAY [Install lighthouse] **********************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]
TASK [Install unzip] ***************************************************************************************************************************************************
ok: [158.160.118.75]
TASK [Get lighthouse distrib] ******************************************************************************************************************************************
changed: [158.160.118.75]
TASK [Unarchive lighthouse distrib into nginx] *************************************************************************************************************************
fatal: [158.160.118.75]: FAILED! => {"changed": false, "msg": "Source './lighthouse.zip' does not exist"}

PLAY RECAP *************************************************************************************************************************************************************
158.160.101.156            : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
158.160.118.75             : ok=7    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
84.201.128.52              : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

ansible-playbook -i inventory/prod.yml site.yml --diff
PLAY [Install Clickhouse] **********************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [84.201.128.52]
TASK [Get clickhouse distrib] ******************************************************************************************************************************************
ok: [84.201.128.52] => (item=clickhouse-client)
ok: [84.201.128.52] => (item=clickhouse-server)
ok: [84.201.128.52] => (item=clickhouse-common-static)

TASK [Install clickhouse packages] *************************************************************************************************************************************
ok: [84.201.128.52]
TASK [Flush handlers] **************************************************************************************************************************************************

TASK [Create database] *************************************************************************************************************************************************
ok: [84.201.128.52]

PLAY [Install Vector] **************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.101.156]

TASK [Get Vector distrib] **********************************************************************************************************************************************
ok: [158.160.101.156]

TASK [Install Vector] **************************************************************************************************************************************************
ok: [158.160.101.156]

PLAY [lighthouse] ******************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Ensure Ansible uses Python 3] ************************************************************************************************************************************
ok: [158.160.118.75]

PLAY [Install nginx] ***************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Install nginx] ***************************************************************************************************************************************************
ok: [158.160.118.75]

PLAY [Install lighthouse] **********************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Install unzip] ***************************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Get lighthouse distrib] ******************************************************************************************************************************************
changed: [158.160.118.75]

TASK [Unarchive lighthouse distrib into nginx] *************************************************************************************************************************
ok: [158.160.118.75]

TASK [Make nginx config] ***********************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Remove lighthouse distrib] ***************************************************************************************************************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "./lighthouse.zip",
-    "state": "file"
+    "state": "absent"
 }

changed: [158.160.118.75]

PLAY RECAP *************************************************************************************************************************************************************
158.160.101.156            : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
158.160.118.75             : ok=10   changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
84.201.128.52              : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
devops@WORKBOOK:~/ansible/mnt-homeworks/08-ansible-03-yandex/playbook$ ansible-playbook -i inventory/prod.yml site.yml --diff

PLAY [Install Clickhouse] **********************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [84.201.128.52]
TASK [Get clickhouse distrib] ******************************************************************************************************************************************
ok: [84.201.128.52] => (item=clickhouse-client)
ok: [84.201.128.52] => (item=clickhouse-server)
ok: [84.201.128.52] => (item=clickhouse-common-static)

TASK [Install clickhouse packages] *************************************************************************************************************************************
ok: [84.201.128.52]
TASK [Flush handlers] **************************************************************************************************************************************************

TASK [Create database] *************************************************************************************************************************************************
ok: [84.201.128.52]
PLAY [Install Vector] **************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.101.156]
TASK [Get Vector distrib] **********************************************************************************************************************************************
ok: [158.160.101.156]
TASK [Install Vector] **************************************************************************************************************************************************
ok: [158.160.101.156]
PLAY [lighthouse] ******************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Ensure Ansible uses Python 3] ************************************************************************************************************************************
ok: [158.160.118.75]

PLAY [Install nginx] ***************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Install nginx] ***************************************************************************************************************************************************
ok: [158.160.118.75]

PLAY [Install lighthouse] **********************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Install unzip] ***************************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Get lighthouse distrib] ******************************************************************************************************************************************
changed: [158.160.118.75]

TASK [Unarchive lighthouse distrib into nginx] *************************************************************************************************************************
ok: [158.160.118.75]

TASK [Make nginx config] ***********************************************************************************************************************************************
ok: [158.160.118.75]

TASK [Remove lighthouse distrib] ***************************************************************************************************************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "./lighthouse.zip",
-    "state": "file"
+    "state": "absent"
 }
changed: [158.160.118.75]
PLAY RECAP *************************************************************************************************************************************************************
158.160.101.156            : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
158.160.118.75             : ok=10   changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
84.201.128.52              : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
Инструкция
Установить ClickHouse:
```
---

### Как оформить решение задания

Выполненное домашнее задание пришлите в виде ссылки на .md-файл в вашем репозитории.

---
